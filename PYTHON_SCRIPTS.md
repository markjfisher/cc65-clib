# Python Script Equivalents

This directory contains Python equivalents of the Perl scripts used in the build process. Both versions produce identical output and can be used interchangeably.

## Scripts

### `clib_imports.py`

Python equivalent of `clib_imports.pl`. Analyzes cc65 object file information (`.info` files generated by `od65`) to:

- Identify which object files can be included in the ROM vs excluded
- Build import/export dependency graphs
- Generate jump tables and import definitions
- Create lists of included/excluded object files

**Usage:**
```bash
python3 clib_imports.py <rom_import.s> <rom_jumps.s> <include_objs.lst> <exclude_objs.lst> [input.info...]
```

**Algorithm:**
1. Parse each `.info` file to extract segments, imports, and exports
2. Exclude files that use disallowed segments (only CODE, RODATA, NULL, ZEROPAGE allowed)
3. Resolve dependencies - exclude files that import symbols not provided by included files
4. Generate output files with import definitions and object file lists

### `clib_stubs.py`

Python equivalent of `clib_stubs.pl`. Extracts symbol information from ld65 map files to create assembler stub definitions.

**Usage:**
```bash
python3 clib_stubs.py <rom_map.map> <output.s>
```

**Algorithm:**
1. Parse the "Exports list by value" section from the map file
2. Extract symbol names, addresses, and types
3. Generate assembler `.export` and `:=` definitions for each symbol
4. Skip internal symbols starting with `__`

## Makefile Integration

The Makefile supports both Perl and Python scripts via the `SCRIPT_LANG` variable:

**Use Python scripts (default):**
```bash
make all
# or explicitly:
make SCRIPT_LANG=python all
```

**Use Perl scripts:**
```bash
make SCRIPT_LANG=perl all
```

## Requirements

### Python Version
- Python 3.6 or later
- Uses only standard library modules (`sys`, `re`, `typing`, `collections`)

### Perl Version  
- Perl 5.x
- Uses only core modules (`strict`)

## Output Compatibility

The Python scripts produce functionally identical output to the Perl versions:
- Same dependency resolution logic
- Same file inclusion/exclusion decisions
- Same assembler output format
- Minor formatting differences (additional debug comments in Python versions)

## Testing

Both script versions are tested against the same input to ensure compatibility:

```bash
# Test with sample .info files
python3 clib_imports.py test_imports.inc test_jumps.inc test_include.lst test_exclude.lst *.info
perl clib_imports.pl test_imports_perl.inc test_jumps_perl.inc test_include_perl.lst test_exclude_perl.lst *.info

# Compare outputs - should be functionally identical
diff test_imports.inc test_imports_perl.inc

# Test with sample map file  
python3 clib_stubs.py test.map test_stubs.s
perl clib_stubs.pl test.map test_stubs_perl.s
diff test_stubs.s test_stubs_perl.s
```

## Migration Benefits

### Accessibility
- Python is more widely known than Perl
- Clearer, more readable code structure
- Better error handling and debugging output

### Maintainability
- Type hints for better code documentation
- Modular class-based design
- Comprehensive docstrings

### Future Extensions
- Easier to add new features (ROM versioning, compatibility checks)
- Better integration with modern toolchains
- Potential for performance optimizations

## Implementation Notes

### Info File Parsing
The `.info` files generated by `od65 --dump-all` have a specific structure:
- Header section with file offsets
- Multiple data sections (Segments, Imports, Exports, etc.)
- Imports/Exports sections appear twice - once as headers, once as data
- The Python parser correctly identifies the data sections vs header sections

### Map File Format
ld65 map files contain an "Exports list by value" section with symbol information:
```
Exports list by value:
-----------------------  
symbol1  address1 type1    symbol2  address2 type2
```

The parser handles both single and double symbol lines, extracting the final character of the type field as the actual symbol type (Z=zeropage, A=absolute, etc.).
